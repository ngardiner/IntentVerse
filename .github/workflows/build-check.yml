name: Build and Test

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Note: We don't need the setup-buildx-action for this simpler approach.
      # Docker Compose will handle the build process.

      - name: Build all service images
        run: docker compose build

      - name: Run Unit Tests
        run: docker compose run --rm core pytest tests/test_filesystem_tool.py

      - name: Run End-to-End Tests
        run: |
          # Start all services in the background
          docker compose up -d

          # Give services a moment to start up
          sleep 15 

          # Run the E2E test script
          docker compose run --rm core pytest tests/test_api_e2e.py
      
      # This step will always run, even if tests fail, to ensure cleanup
      - name: Stop services
        if: always()
        run: docker compose down